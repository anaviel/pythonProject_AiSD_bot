from sqlalchemy import create_engine, distinct
from datetime import datetime
from telebot import types
from bot_start import bot
from database_editing import Classes, SubscriptionInfo, Session


engine = create_engine('sqlite:///rasp.db', echo=False)

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
pages_registr = {}


# —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è"
def sign_up_for_training(message, user_id=None):
    session = Session()

    if user_id is None:
        user_id = message.from_user.id
    subscription = session.query(SubscriptionInfo.subscription).filter_by(id=user_id).scalar()

    if subscription:
        if subscription > 0:
            dates_ = session.query(distinct(Classes.date)).all()
            dates = []
            for row in dates_:
                if row[0] not in dates:
                    dates.append(row[0])

            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            current_page = pages_registr.get(user_id, 0)

            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            items_per_page = 5
            start_index = current_page * items_per_page
            end_index = start_index + items_per_page

            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –¥–∞—Ç–∞–º–∏ –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            keyboard = types.InlineKeyboardMarkup(row_width=2)
            for date in dates[start_index:end_index]:
                butt = 'date:' + date
                button = types.InlineKeyboardButton(text=date, callback_data=butt)
                keyboard.add(button)

            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ "–í–ø–µ—Ä—ë–¥" –∏ "–ù–∞–∑–∞–¥"
            if current_page > 0:
                prev_button = types.InlineKeyboardButton(text='–ù–∞–∑–∞–¥', callback_data='prev_page_3')
                keyboard.row(prev_button)
            if end_index < len(dates):
                next_button = types.InlineKeyboardButton(text='–í–ø–µ—Ä—ë–¥', callback_data='next_page_3')
                keyboard.row(next_button)
            bot.send_message(message.chat.id, '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å:', reply_markup=keyboard)
        else:
            bot.send_message(message.chat.id,
                             "–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ, —Ç–∞–∫ –∫–∞–∫ —É –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç.\n"
                             "–í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ —Å—Ç—É–¥–∏–∏ –¥–ª—è –µ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è.")
    else:
        bot.send_message(message.chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ.")

    session.close()


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫ "–í–ø–µ—Ä—ë–¥" –∏ "–ù–∞–∑–∞–¥"
@bot.callback_query_handler(func=lambda callback: callback.data in ['prev_page_3', 'next_page_3'])
def callback_pagination(callback):
    bot.delete_message(callback.message.chat.id, callback.message.message_id)
    user_id = callback.from_user.id
    current_page = pages_registr.get(user_id, 0)

    if callback.data == 'prev_page_3':
        current_page = max(0, current_page - 1)
    elif callback.data == 'next_page_3':
        current_page += 1

    pages_registr[user_id] = current_page

    # –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    sign_up_for_training(callback.message, user_id)


@bot.callback_query_handler(func=lambda callback: 'date:' in callback.data)
def callback_dates_show(callback):
    bot.delete_message(callback.message.chat.id, callback.message.message_id)
    markup = types.InlineKeyboardMarkup()
    date = callback.data.split(':')[1]
    rasp_list_available, rasp_list_unavailable = rasp_show(date)
    if not rasp_list_available:
        bot.send_message(callback.message.chat.id, "üõèÔ∏è –ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–Ω—è—Ç–∏–π –±–æ–ª—å—à–µ –Ω–µ—Ç.")
        return
    rasp_str = f'–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –Ω–∞ {date}:\n\n'
    for string in rasp_list_available:
        rasp_str += string
        rasp_str += '\n'
    rasp_str = rasp_str + '‚ûñ\n'
    for string in rasp_list_unavailable:
        rasp_str += string
        rasp_str += '\n'
    rasp_str += '\n–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—Ç–µ–ª–∏ –±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è:'
    for i in rasp_list_available:
        napr = i.split(',')[0][1:]
        reg = 'reg_' + date + '_' + napr
        button = types.InlineKeyboardButton(napr, callback_data=reg)
        markup.add(button)
    back_button = types.InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_sign_up")
    markup.add(back_button)
    bot.send_message(callback.message.chat.id, rasp_str, reply_markup=markup)


@bot.callback_query_handler(func=lambda callback: "back_to_sign_up" in callback.data)
def callback_back(callback):
    user_id = callback.from_user.id
    bot.delete_message(callback.message.chat.id, callback.message.message_id)
    sign_up_for_training(callback.message, user_id)


def rasp_show(date):
    session = Session()

    now = datetime.now()

    rows_available = session.query(distinct(Classes.napr), Classes.coach).filter(
        Classes.date == str(date),
        Classes.id == '-',
        Classes.visitor == '-'
    ).all()

    full_classes = session.query(distinct(Classes.napr), Classes.coach).filter(
        Classes.date == str(date),
        Classes.id != '-',
        Classes.visitor != '-'
    ).all()

    rows_unavailable = list(set(full_classes) - set(rows_available))

    rasp_list_available = []
    rasp_list_unavailable = []

    for row in rows_available:
        napr, coach = row
        if now < datetime.strptime(f"{date} {napr[:5]}", "%d-%m-%Y %H:%M"):
            rasp_list_available.append(f"ü§ç{napr}, —Ç—Ä–µ–Ω–µ—Ä: {coach}")

    for row in rows_unavailable:
        napr, coach = row
        full_date = date + ' ' + napr[:5]
        print(now, datetime.strptime(full_date, "%d-%m-%Y %H:%M"))
        if now < datetime.strptime(full_date, "%d-%m-%Y %H:%M"):
            rasp_list_unavailable.append(f"ü§ç{napr}, —Ç—Ä–µ–Ω–µ—Ä: {coach} (‚ùå–ù–∞ –¥–∞–Ω–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ –º–µ—Å—Ç —É–∂–µ –Ω–µ—Ç!)")

    session.close()

    return rasp_list_available, rasp_list_unavailable


@bot.callback_query_handler(func=lambda callback: 'reg_' in callback.data)
def callback_reg(callback):
    session = Session()

    bot.delete_message(callback.message.chat.id, callback.message.message_id)
    user_id = callback.from_user.id

    subscription = session.query(SubscriptionInfo).filter_by(id=user_id).first()

    if subscription and subscription.subscription > 0:
        data_parts = callback.data.split('_')
        date = data_parts[1]
        napr = data_parts[2]

        coach = (session.query(Classes.coach).filter_by(date=date, napr=napr).first())[0]

        from database_editing import update_visitor
        update_visitor(date, napr, coach, user_id, subscription.visitor)

        result = session.query(SubscriptionInfo.subscription).filter_by(id=user_id,
                                                                        visitor=subscription.visitor).scalar()
        new_subscription = result - 1

        session.query(SubscriptionInfo).filter_by(id=user_id, visitor=subscription.visitor).update({
            SubscriptionInfo.subscription: new_subscription
        })

        session.commit()

        bot.send_message(callback.message.chat.id,
                         f'–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã {date} –Ω–∞ {napr}.\n–° –±–∞–ª–∞–Ω—Å–∞ –í–∞—à–µ–≥–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ –±—ã–ª–æ —Å–ø–∏—Å–∞–Ω–æ –æ–¥–Ω–æ –∑–∞–Ω—è—Ç–∏–µ.')
    else:
        bot.send_message(callback.message.chat.id, '–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–Ω—è—Ç–∏–π –Ω–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–µ.')

    session.close()


def is_user_enter(id, date, napr):
    session = Session()

    result = session.query(Classes).filter_by(date=date, napr=napr, id=id).all()

    session.close()

    return len(result) > 0


# —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–ø–∏—Å—å"
def cancel_registration_for_training(message):
    session = Session()

    user_id = message.from_user.id
    dates_napr_ = session.query(Classes.date, Classes.napr).filter_by(id=user_id).all()
    markup = types.InlineKeyboardMarkup()

    for date, napr in dates_napr_:
        butt = 'date-napr_' + date + '_' + napr
        name_butt = date + ' ' + napr
        button = types.InlineKeyboardButton(name_butt, callback_data=butt)
        markup.add(button)

    bot.send_message(message.chat.id, '–ö–∞–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å?', reply_markup=markup)

    session.close()


@bot.callback_query_handler(func=lambda callback: 'date-napr_' in callback.data)
def callback_cancel(callback):
    session = Session()

    user_id = callback.from_user.id
    name = session.query(SubscriptionInfo.visitor).filter_by(id=user_id).scalar()
    date_napr = callback.data.split('_')
    date = date_napr[1]
    napr = date_napr[2]
    session.query(Classes).filter_by(date=date, napr=napr).update({
        Classes.id: '-',
        Classes.visitor: '-'
    })
    result = session.query(SubscriptionInfo.subscription).filter_by(id=user_id, visitor=name).scalar()
    new_subscription = result + 1
    session.query(SubscriptionInfo).filter_by(id=user_id, visitor=name).update({
        SubscriptionInfo.subscription: new_subscription
    })
    session.commit()
    bot.send_message(callback.message.chat.id,
                     f'–ó–∞–ø–∏—Å—å –Ω–∞ {date}, "{napr}" —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞.'
                     f'\n–ù–∞ –±–∞–ª–∞–Ω—Å –í–∞—à–µ–≥–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ –±—ã–ª–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ –æ–¥–Ω–æ –∑–∞–Ω—è—Ç–∏–µ.')

    session.close()

